name: Update Parent Issues on Comment

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: read
  contents: read

jobs:
  update-parent-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install GitHub CLI and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: Authenticate with GitHub CLI
        run: gh auth login --with-token <<< ${{ secrets.GITHUB_TOKEN }}

      - name: Update Parent Issues
        run: |
          set -e

          ISSUE_NUMBER=${{ github.event.issue.number }}
          REPO=${{ github.repository }}

          echo "Fetching issue body for issue #$ISSUE_NUMBER"
          BODY=$(gh issue view $ISSUE_NUMBER --json body -q .body)
          echo "Issue body: $BODY"

          echo "Extracting parent issues"
          PARENTS_LINE=$(echo "$BODY" | grep -oP 'Parents:\s*#[0-9, ]+')
          
          if [ -z "$PARENTS_LINE" ]; then
            echo "No Parents found in the issue body for #$ISSUE_NUMBER, exiting."
            exit 1
          fi
          
          echo "Parents line: $PARENTS_LINE"

          # Extracting the parent IDs
          PARENT_IDS=$(echo "$PARENTS_LINE" | grep -oP '#\d+' | grep -oP '\d+')
          
          if [ -z "$PARENT_IDS" ]; then
            echo "No valid parent IDs found in the line: $PARENTS_LINE"
            exit 1
          fi

          echo "Parent IDs: $PARENT_IDS"

          for PARENT_ID in $PARENT_IDS; do
            echo "Processing parent #$PARENT_ID"

            PARENT_DESCRIPTION=$(gh issue view $PARENT_ID --json body -q .body)
            echo "Parent issue description: $PARENT_DESCRIPTION"

            # Check if the child issue is already listed
            CHILD_TAG="#$ISSUE_NUMBER"
            if echo "$PARENT_DESCRIPTION" | grep -q "Child:.*$CHILD_TAG"; then
              echo "Child issue #$ISSUE_NUMBER already listed in parent #$PARENT_ID, skipping."
              continue
            fi

            # Append the current child issue number to the Child line
            if echo "$PARENT_DESCRIPTION" | grep -q "Child:"; then
              # Add the child issue number to the existing Child line
              UPDATED_DESCRIPTION=$(echo "$PARENT_DESCRIPTION" | sed "s/Child:/Child: $CHILD_TAG,/")
            else
              # Add a new Child line
              UPDATED_DESCRIPTION="Child: $CHILD_TAG\n\n$PARENT_DESCRIPTION"
            fi

            echo "Updated parent description: $UPDATED_DESCRIPTION"

            # Update the parent issue with the new description
            gh issue edit $PARENT_ID --body "$UPDATED_DESCRIPTION"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

